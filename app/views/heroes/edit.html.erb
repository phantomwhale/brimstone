<%= form_with(model: @hero, class: "w-full max-w-4xl mx-auto") do |form| %>
  <% if @hero.errors.any? %>
    <div class="bg-red-50 border-2 border-blood rounded p-4 mb-4 text-blood font-body">
      <h2 class="font-bold"><%= pluralize(@hero.errors.count, "error") %> prohibited this hero from being saved:</h2>
      <ul class="list-disc list-inside mt-2">
        <% @hero.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="hero-sheet">
    <%# Header Section %>
    <header class="sheet-header">
      <div class="flex-1">
        <div class="flex items-center gap-2 mb-3">
          <%= form.label :name, "Name:", class: "font-serif font-bold text-parchment-light" %>
          <%= form.text_field :name, class: "hero-name-input", placeholder: "Enter hero name" %>
        </div>
        <div class="flex items-center gap-2">
          <%= form.label :hero_class, "Class:", class: "font-serif font-bold text-parchment-light text-sm" %>
          <%= form.select :hero_class,
              options_for_select(HeroClasses.names.map { |name| [name.titleize.gsub('_', ' '), name] }, @hero.hero_class),
              { include_blank: "Select Class" },
              { class: "hero-class-select" } %>
        </div>
      </div>
      <div class="sheet-header-title">
        <h1>Shadows of Brimstone</h1>
        <h2>Hero Sheet</h2>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-[240px_1fr] gap-6 p-6">
      <%# Left Column: Portrait Area %>
      <aside class="flex flex-col gap-4">
        <div class="portrait-frame cursor-pointer" onclick="document.getElementById('portrait-modal').showModal()">
          <% if @hero.portrait.present? %>
            <%= image_tag "portraits/#{@hero.portrait}.jpg", class: "portrait-image", alt: portrait_display_name(@hero.portrait) %>
          <% else %>
            <div class="portrait-placeholder">
              <span>Click to<br>Select Portrait</span>
            </div>
          <% end %>
        </div>
        <%= form.hidden_field :portrait, id: "hero_portrait_field" %>
        
        <div class="info-box">
          <h3 class="info-box-title">Keywords</h3>
          <div class="min-h-[40px]"></div>
        </div>
        <div class="info-box">
          <h3 class="info-box-title">Modifiers for the Current Adventure...</h3>
          <div class="min-h-[40px]"></div>
        </div>
      </aside>
      
      <%# Portrait Selection Modal %>
      <dialog id="portrait-modal" class="portrait-modal">
        <div class="portrait-modal-content">
          <div class="portrait-modal-header">
            <h2 class="font-western text-xl text-gold">Select Portrait</h2>
            <button type="button" onclick="document.getElementById('portrait-modal').close()" class="portrait-modal-close">&times;</button>
          </div>
          <div class="portrait-grid">
            <% available_portraits.each do |portrait| %>
              <div class="portrait-option" data-portrait="<%= portrait %>" data-portrait-url="<%= image_path("portraits/#{portrait}.jpg") %>" onclick="selectPortrait(this)">
                <%= image_tag "portraits/#{portrait}.jpg", alt: portrait_display_name(portrait), class: "portrait-thumbnail" %>
                <span class="portrait-name"><%= portrait_display_name(portrait) %></span>
              </div>
            <% end %>
          </div>
        </div>
      </dialog>
      
      <script>
        function selectPortrait(element) {
          const portrait = element.dataset.portrait;
          const portraitUrl = element.dataset.portraitUrl;
          document.getElementById('hero_portrait_field').value = portrait;
          const frame = document.querySelector('.portrait-frame');
          frame.innerHTML = '<img src="' + portraitUrl + '" class="portrait-image" alt="' + portrait + '">';
          document.getElementById('portrait-modal').close();
        }
      </script>
      
      <%# Token Picker Modal %>
      <dialog id="token-picker-modal" class="token-picker-modal">
        <div class="token-picker-content">
          <div class="token-picker-header">
            <h2 class="font-western text-xl text-gold">Add Token to Side Bag</h2>
            <button type="button" onclick="document.getElementById('token-picker-modal').close()" class="token-picker-close">&times;</button>
          </div>
          <div class="token-picker-body">
            <% grouped_sidebag_tokens.each do |category, tokens| %>
              <div class="token-category">
                <h3 class="token-category-title"><%= category %></h3>
                <div class="token-picker-grid">
                  <% tokens.each do |token| %>
                    <div class="token-option" data-token="<%= token %>" data-token-url="<%= image_path("tokens/sidebag/#{token}.png") %>" data-token-name="<%= token_display_name(token) %>" onclick="addToken(this)">
                      <%= image_tag "tokens/sidebag/#{token}.png", alt: token_display_name(token), class: "token-thumbnail" %>
                      <span class="token-option-name"><%= token_display_name(token) %></span>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </dialog>
      
      <script>
        // Get current sidebag tokens from hidden field
        function getSidebagTokens() {
          const field = document.getElementById('sidebag_contents_field');
          try {
            return JSON.parse(field.value) || [];
          } catch (e) {
            return [];
          }
        }
        
        // Save sidebag tokens to hidden field
        function setSidebagTokens(tokens) {
          document.getElementById('sidebag_contents_field').value = JSON.stringify(tokens);
          updateSidebagCount();
        }
        
        // Update the token count display
        function updateSidebagCount() {
          const tokens = getSidebagTokens();
          document.getElementById('sidebag-count').textContent = tokens.length;
        }
        
        // Update capacity display when input changes
        document.querySelector('.sidebag-capacity-input')?.addEventListener('change', function() {
          document.getElementById('sidebag-capacity-display').textContent = this.value;
        });
        
        // Add a token to the sidebag
        function addToken(element) {
          const token = element.dataset.token;
          const tokenUrl = element.dataset.tokenUrl;
          const tokenName = element.dataset.tokenName;
          const tokens = getSidebagTokens();
          const capacity = parseInt(document.getElementById('sidebag-capacity-display').textContent) || 5;
          
          if (tokens.length >= capacity) {
            alert('Side bag is full! Increase capacity or remove a token first.');
            return;
          }
          
          tokens.push(token);
          setSidebagTokens(tokens);
          
          // Add token to the visual container
          const container = document.getElementById('sidebag-tokens-container');
          const tokenDiv = document.createElement('div');
          tokenDiv.className = 'sidebag-token';
          tokenDiv.dataset.token = token;
          tokenDiv.innerHTML = `
            <img src="${tokenUrl}" alt="${tokenName}" class="sidebag-token-image">
            <span class="sidebag-token-name">${tokenName}</span>
            <button type="button" class="sidebag-token-remove" onclick="removeToken(this, '${token}')">&times;</button>
          `;
          container.appendChild(tokenDiv);
          
          document.getElementById('token-picker-modal').close();
        }
        
        // Remove a token from the sidebag
        function removeToken(button, token) {
          const tokens = getSidebagTokens();
          const index = tokens.indexOf(token);
          if (index > -1) {
            tokens.splice(index, 1);
            setSidebagTokens(tokens);
          }
          
          // Remove from visual display
          button.closest('.sidebag-token').remove();
        }
      </script>

      <%# Main Stats Area %>
      <main class="flex flex-col gap-5">
        <%# Top row: Attributes + Initiative/Corruption %>
        <div class="flex gap-4">
          <%# Core Attributes (6 stats in 2 rows of 3) %>
          <section class="attributes-section flex-1">
            <div class="grid grid-cols-3 gap-4 mb-4">
              <div class="flex flex-col items-center gap-2">
                <%= form.label :agility, class: "attribute-label" %>
                <%= form.number_field :agility, class: "attribute-input", min: 0 %>
              </div>
              <div class="flex flex-col items-center gap-2">
                <%= form.label :cunning, class: "attribute-label" %>
                <%= form.number_field :cunning, class: "attribute-input", min: 0 %>
              </div>
              <div class="flex flex-col items-center gap-2">
                <%= form.label :spirit, class: "attribute-label" %>
                <%= form.number_field :spirit, class: "attribute-input", min: 0 %>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="flex flex-col items-center gap-2">
                <%= form.label :strength, class: "attribute-label" %>
                <%= form.number_field :strength, class: "attribute-input", min: 0 %>
              </div>
              <div class="flex flex-col items-center gap-2">
                <%= form.label :lore, class: "attribute-label" %>
                <%= form.number_field :lore, class: "attribute-input", min: 0 %>
              </div>
              <div class="flex flex-col items-center gap-2">
                <%= form.label :luck, class: "attribute-label" %>
                <%= form.number_field :luck, class: "attribute-input", min: 0 %>
              </div>
            </div>
          </section>

          <%# Initiative & Corruption (stacked on right) %>
          <div class="flex flex-col gap-4">
            <div class="initiative-box">
              <%= form.label :initiative, class: "font-western text-xs text-parchment-light uppercase" %>
              <%= form.number_field :initiative, class: "initiative-input", min: 0 %>
            </div>
            <div class="corruption-box">
              <%= form.label :corrupt_resist, "Corruption Resistance", class: "font-western text-[10px] text-parchment-light uppercase text-center leading-tight" %>
              <%= form.number_field :corrupt_resist, class: "corruption-input", min: 0 %>
            </div>
          </div>
        </div>

        <%# Combat Stats Section %>
        <section class="combat-section">
          <div class="flex flex-wrap gap-6 items-start">
            <div>
              <h3 class="font-western text-base text-wood-dark mb-3">To Hit:</h3>
              <div class="flex gap-6">
                <div class="flex flex-col items-center gap-2">
                  <%= form.label :range_to_hit, "Ranged", class: "font-serif text-sm font-bold text-wood-dark" %>
                  <%= form.number_field :range_to_hit, class: "to-hit-input", min: 0 %>
                </div>
                <div class="flex flex-col items-center gap-2">
                  <%= form.label :melee_to_hit, "Melee", class: "font-serif text-sm font-bold text-wood-dark" %>
                  <%= form.number_field :melee_to_hit, class: "to-hit-input", min: 0 %>
                </div>
              </div>
            </div>
            <div class="flex flex-col gap-3">
              <div class="flex items-center gap-2 bg-parchment-light border-2 border-wood rounded-md px-3 py-2">
                <%= form.label :combat, "Combat:", class: "font-serif text-sm font-bold text-wood-dark whitespace-nowrap" %>
                <%= form.number_field :combat, class: "combat-input", min: 0 %>
              </div>
              <div class="flex items-center gap-2 bg-parchment-light border-2 border-wood rounded-md px-3 py-2">
                <%= form.label :max_grit, "Max Grit:", class: "font-serif text-sm font-bold text-wood-dark whitespace-nowrap" %>
                <%= form.number_field :max_grit, class: "combat-input", min: 0 %>
              </div>
            </div>
          </div>
        </section>

        <%# Health and Sanity Section %>
        <section class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="health-section">
            <div class="font-western text-lg text-parchment-light uppercase text-center mb-3" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
              Health
            </div>
            <div class="flex items-center gap-4">
              <%= form.number_field :health, class: "health-input", min: 0, placeholder: "HP" %>
              <div class="flex flex-col items-center gap-1">
                <%= form.label :defense, class: "font-serif text-xs text-parchment-light uppercase" %>
                <%= form.number_field :defense, class: "defense-input", min: 0 %>
              </div>
            </div>
          </div>
          <div class="sanity-section">
            <div class="font-western text-lg text-parchment-light uppercase text-center mb-3" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
              Sanity
            </div>
            <div class="flex items-center gap-4">
              <%= form.number_field :sanity, class: "sanity-input", min: 0, placeholder: "San" %>
              <div class="flex flex-col items-center gap-1">
                <%= form.label :willpower, class: "font-serif text-xs text-parchment-light uppercase" %>
                <%= form.number_field :willpower, class: "willpower-input", min: 0 %>
              </div>
            </div>
          </div>
        </section>

        <%# Resources Section %>
        <section class="resources-section">
          <h3 class="font-western text-lg text-wood-dark text-center border-b-2 border-parchment-border pb-2 mb-4">
            Resources
          </h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            <div class="flex flex-col items-center gap-2">
              <%= form.label :experience, "Experience", class: "font-serif text-sm font-bold text-wood-dark text-center" %>
              <%= form.number_field :experience, class: "resource-input", min: 0 %>
            </div>
            <div class="flex flex-col items-center gap-2">
              <%= form.label :gold, "Gold", class: "font-serif text-sm font-bold text-wood-dark text-center" %>
              <%= form.number_field :gold, class: "resource-input gold", min: 0 %>
            </div>
            <div class="flex flex-col items-center gap-2">
              <%= form.label :dark_stone, "Dark Stone", class: "font-serif text-sm font-bold text-wood-dark text-center" %>
              <%= form.number_field :dark_stone, class: "resource-input darkstone", min: 0 %>
            </div>
          </div>
        </section>
        
        <%# Side Bag Section %>
        <section class="sidebag-section">
          <div class="flex items-center justify-between border-b-2 border-parchment-border pb-2 mb-4">
            <h3 class="font-western text-lg text-wood-dark">Side Bag</h3>
            <div class="flex items-center gap-2">
              <span class="font-serif text-sm text-wood-dark">Capacity:</span>
              <%= form.number_field :sidebag_capacity, class: "sidebag-capacity-input", min: 1, max: 20 %>
            </div>
          </div>
          
          <%# Current tokens in sidebag %>
          <div class="sidebag-contents mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="font-serif text-sm text-wood-dark">
                Tokens: <span id="sidebag-count"><%= @hero.sidebag_count %></span> / <span id="sidebag-capacity-display"><%= @hero.sidebag_capacity || 5 %></span>
              </span>
              <button type="button" onclick="document.getElementById('token-picker-modal').showModal()" class="btn-add-token">
                + Add Token
              </button>
            </div>
            <div id="sidebag-tokens-container" class="sidebag-tokens-grid">
              <% @hero.sidebag_tokens.each_with_index do |token, index| %>
                <div class="sidebag-token" data-token="<%= token %>">
                  <%= image_tag "tokens/sidebag/#{token}.png", alt: token_display_name(token), class: "sidebag-token-image" %>
                  <span class="sidebag-token-name"><%= token_display_name(token) %></span>
                  <button type="button" class="sidebag-token-remove" onclick="removeToken(this, '<%= token %>')">&times;</button>
                </div>
              <% end %>
            </div>
            <%= form.hidden_field :sidebag_contents, id: "sidebag_contents_field", value: @hero.sidebag_tokens.to_json %>
          </div>
        </section>
      </main>
    </div>

    <%# Form Actions %>
    <footer class="sheet-footer">
      <div class="flex justify-center gap-4 flex-wrap">
        <%= form.submit "Save Hero", class: "btn-save" %>
        <%= link_to "Cancel", @hero, class: "btn-secondary" %>
        <%= link_to "Back to Heroes", heroes_path, class: "btn-secondary" %>
      </div>
    </footer>
  </div>
<% end %>
