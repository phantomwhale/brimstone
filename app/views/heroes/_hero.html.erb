<div id="<%= dom_id hero %>" class="hero-sheet max-w-4xl mx-auto">
  <%# Header Section %>
  <header class="sheet-header">
    <div class="flex-1">
      <div class="flex items-center gap-2 mb-2">
        <span class="font-serif font-bold text-parchment-light">Name:</span>
        <span class="font-body text-xl text-gold"><%= hero.name %></span>
      </div>
      <div class="flex items-center gap-2">
        <span class="font-serif font-bold text-parchment-light text-sm">Class:</span>
        <span class="font-body text-lg text-parchment-light"><%= hero.hero_class&.titleize&.gsub('_', ' ') %></span>
      </div>
    </div>
    <div class="sheet-header-title">
      <h1>Shadows of Brimstone</h1>
      <h2>Hero Sheet</h2>
    </div>
  </header>

  <div class="grid grid-cols-1 md:grid-cols-[240px_1fr] gap-6 p-6">
    <%# Left Column: Portrait Area %>
    <aside class="flex flex-col gap-4">
      <div class="portrait-frame">
        <% if hero.portrait.present? %>
          <%= image_tag "portraits/#{hero.portrait}.jpg", class: "portrait-image", alt: portrait_display_name(hero.portrait) %>
        <% else %>
          <div class="portrait-placeholder">
            <span>No Portrait</span>
          </div>
        <% end %>
      </div>
      <div class="info-box">
        <h3 class="info-box-title">Keywords</h3>
        <div class="min-h-[40px] text-center text-sm text-parchment-border italic">
          <em>No keywords assigned</em>
        </div>
      </div>
    </aside>

    <%# Main Stats Area %>
    <main class="flex flex-col gap-5">
      <%# Top row: Attributes + Initiative/Corruption %>
      <div class="flex gap-4">
        <%# Core Attributes (6 stats in 2 rows of 3) %>
        <section class="attributes-section flex-1">
          <div class="grid grid-cols-3 gap-4 mb-4">
            <% [
              ['Agility', 'agility'],
              ['Cunning', 'cunning'],
              ['Spirit', 'spirit']
            ].each do |attr_name, attr_key| %>
              <div class="flex flex-col items-center gap-2">
                <span class="attribute-label"><%= attr_name %></span>
                <div class="attribute-display <%= adjustment_indicator_class(hero, attr_key) %>">
                  <%= hero.adjusted_value_for(attr_key) %>
                  <% if (adj = adjustment_amount(hero, attr_key)) %>
                    <span class="adjustment-indicator"><%= adj %></span>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <% [
              ['Strength', 'strength'],
              ['Lore', 'lore'],
              ['Luck', 'luck']
            ].each do |attr_name, attr_key| %>
              <div class="flex flex-col items-center gap-2">
                <span class="attribute-label"><%= attr_name %></span>
                <div class="attribute-display <%= adjustment_indicator_class(hero, attr_key) %>">
                  <%= hero.adjusted_value_for(attr_key) %>
                  <% if (adj = adjustment_amount(hero, attr_key)) %>
                    <span class="adjustment-indicator"><%= adj %></span>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </section>

        <%# Initiative & Corruption (stacked on right) %>
        <div class="flex flex-col gap-4">
          <div class="initiative-box">
            <span class="font-western text-xs text-parchment-light uppercase">Initiative</span>
            <div class="initiative-display <%= adjustment_indicator_class(hero, 'initiative') %>">
              <%= hero.adjusted_initiative %>
              <% if (adj = adjustment_amount(hero, 'initiative')) %>
                <span class="adjustment-indicator"><%= adj %></span>
              <% end %>
            </div>
          </div>
          <div class="corruption-box">
            <span class="font-western text-[10px] text-parchment-light uppercase text-center leading-tight">Corruption Resistance</span>
            <div class="corruption-display <%= adjustment_indicator_class(hero, 'corrupt_resist') %>">
              <%= hero.adjusted_corrupt_resist %>
              <% if (adj = adjustment_amount(hero, 'corrupt_resist')) %>
                <span class="adjustment-indicator"><%= adj %></span>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%# Combat Stats Section %>
      <section class="combat-section">
        <div class="flex flex-wrap gap-6 items-start">
          <div>
            <h3 class="font-western text-base text-wood-dark mb-3">To Hit:</h3>
            <div class="flex gap-6">
              <div class="flex flex-col items-center gap-2">
                <span class="font-serif text-sm font-bold text-wood-dark">Ranged</span>
                <div class="to-hit-display">
                  <%= format_dice_target(hero.range_to_hit) %>
                </div>
              </div>
              <div class="flex flex-col items-center gap-2">
                <span class="font-serif text-sm font-bold text-wood-dark">Melee</span>
                <div class="to-hit-display">
                  <%= format_dice_target(hero.melee_to_hit) %>
                </div>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3">
            <div class="flex items-center gap-2 bg-parchment-light border-2 border-wood rounded-md px-3 py-2">
              <span class="font-serif text-sm font-bold text-wood-dark whitespace-nowrap">Combat:</span>
              <div class="combat-display <%= adjustment_indicator_class(hero, 'combat') %>">
                <%= hero.adjusted_combat %>
                <% if (adj = adjustment_amount(hero, 'combat')) %>
                  <span class="adjustment-indicator"><%= adj %></span>
                <% end %>
              </div>
            </div>
            <div class="flex items-center gap-2 bg-parchment-light border-2 border-wood rounded-md px-3 py-2">
              <span class="font-serif text-sm font-bold text-wood-dark whitespace-nowrap">Max Grit:</span>
              <div class="combat-display <%= adjustment_indicator_class(hero, 'max_grit') %>">
                <%= hero.adjusted_max_grit %>
                <% if (adj = adjustment_amount(hero, 'max_grit')) %>
                  <span class="adjustment-indicator"><%= adj %></span>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </section>

      <%# Health and Sanity Section %>
      <section class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="health-section">
          <div class="font-western text-lg text-parchment-light uppercase text-center mb-3" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
            Health
          </div>
          <div class="flex items-center gap-4">
            <div class="health-display <%= adjustment_indicator_class(hero, 'health') %>">
              <%= hero.adjusted_health %>
              <% if (adj = adjustment_amount(hero, 'health')) %>
                <span class="adjustment-indicator"><%= adj %></span>
              <% end %>
            </div>
            <div class="flex flex-col items-center gap-1">
              <span class="font-serif text-xs text-parchment-light uppercase">Defense</span>
              <div class="defense-display">
                <%= format_dice_target(hero.defense) %>
              </div>
            </div>
          </div>
        </div>
        <div class="sanity-section">
          <div class="font-western text-lg text-parchment-light uppercase text-center mb-3" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
            Sanity
          </div>
          <div class="flex items-center gap-4">
            <div class="sanity-display <%= adjustment_indicator_class(hero, 'sanity') %>">
              <%= hero.adjusted_sanity %>
              <% if (adj = adjustment_amount(hero, 'sanity')) %>
                <span class="adjustment-indicator"><%= adj %></span>
              <% end %>
            </div>
            <div class="flex flex-col items-center gap-1">
              <span class="font-serif text-xs text-parchment-light uppercase">Willpower</span>
              <div class="willpower-display">
                <%= format_dice_target(hero.willpower) %>
              </div>
            </div>
          </div>
        </div>
      </section>

      <%# Resources Section %>
      <section class="resources-section">
        <h3 class="font-western text-lg text-wood-dark text-center border-b-2 border-parchment-border pb-2 mb-4">
          Resources
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <div class="flex flex-col items-center gap-2">
            <span class="font-serif text-sm font-bold text-wood-dark text-center">Experience</span>
            <div class="resource-display"><%= hero.experience %></div>
          </div>
          <div class="flex flex-col items-center gap-2">
            <span class="font-serif text-sm font-bold text-wood-dark text-center">Gold</span>
            <div class="resource-display gold"><%= hero.gold %></div>
          </div>
          <div class="flex flex-col items-center gap-2">
            <span class="font-serif text-sm font-bold text-wood-dark text-center">Dark Stone</span>
            <div class="resource-display darkstone"><%= hero.dark_stone %></div>
          </div>
        </div>
      </section>
      
      <%# Side Bag Section %>
      <section class="sidebag-section-display">
        <div class="flex items-center justify-between border-b-2 border-parchment-border pb-2 mb-4">
          <h3 class="font-western text-lg text-wood-dark">Side Bag</h3>
          <div class="flex items-center gap-3">
            <span class="font-serif text-sm text-wood-dark">
              <%= hero.sidebag_count %> / <%= hero.adjusted_sidebag_capacity %> tokens
              <% if hero.has_adjustment_for?('sidebag_capacity') %>
                <span class="text-xs <%= hero.total_adjustment_for('sidebag_capacity') > 0 ? 'text-green-700' : 'text-red-500' %>">
                  (<%= adjustment_amount(hero, 'sidebag_capacity') %>)
                </span>
              <% end %>
            </span>
            <% unless hero.sidebag_full? %>
              <button type="button" onclick="document.getElementById('token-picker-modal-<%= hero.id %>').showModal()" class="btn-add-token">
                + Add Token
              </button>
            <% end %>
          </div>
        </div>
        
        <% if hero.sidebag_tokens.any? %>
          <div class="sidebag-tokens-display">
            <% hero.sidebag_tokens.each_with_index do |token, index| %>
              <div class="sidebag-token" title="<%= token_display_name(token) %>">
                <%= image_tag "tokens/sidebag/#{token}.png", alt: token_display_name(token), class: "sidebag-token-image" %>
                <span class="sidebag-token-name"><%= token_display_name(token) %></span>
                <%= button_to hero_sidebag_token_path(hero, index), 
                    method: :delete, 
                    class: "sidebag-token-remove",
                    title: "Remove token" do %>
                  &times;
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center text-parchment-border italic py-4">
            No tokens in side bag
          </div>
        <% end %>
      </section>
      
      <%# Token Picker Modal %>
      <dialog id="token-picker-modal-<%= hero.id %>" class="token-picker-modal">
        <div class="token-picker-content">
          <div class="token-picker-header">
            <h2 class="font-western text-xl text-gold">Add Token to Side Bag</h2>
            <button type="button" onclick="document.getElementById('token-picker-modal-<%= hero.id %>').close()" class="token-picker-close">&times;</button>
          </div>
          <div class="token-picker-body">
            <% grouped_sidebag_tokens.each do |category, tokens| %>
              <div class="token-category">
                <h3 class="token-category-title"><%= category %></h3>
                <div class="token-picker-grid">
                  <% tokens.each do |token| %>
                    <%= button_to hero_sidebag_tokens_path(hero, token: token), 
                        method: :post,
                        class: "token-option",
                        form: { data: { turbo_frame: "_top" } } do %>
                      <%= image_tag "tokens/sidebag/#{token}.png", alt: token_display_name(token), class: "token-thumbnail" %>
                      <span class="token-option-name"><%= token_display_name(token) %></span>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </dialog>
    </main>
  </div>

  <%# Adjustments Section %>
  <div class="p-6 pt-0">
    <section class="adjustments-section">
      <% standalone_adjustments = hero.adjustments.standalone %>
      <div class="flex items-center justify-between border-b-2 border-parchment-border pb-2 mb-4">
        <h3 class="font-western text-lg text-wood-dark">Adjustments</h3>
        <span class="font-serif text-sm text-wood-dark">
          <%= standalone_adjustments.active.count %> active / <%= standalone_adjustments.count %> total
        </span>
      </div>
      
      <div id="adjustments-list" class="adjustments-list">
        <% if standalone_adjustments.any? %>
          <%= render standalone_adjustments.order(active: :desc, created_at: :desc) %>
        <% else %>
          <div class="text-center text-parchment-border italic py-4" id="no-adjustments-message">
            No adjustments yet
          </div>
        <% end %>
      </div>
      
      <div class="mt-4">
        <%= render "adjustments/form", hero: hero, adjustment: hero.adjustments.build %>
      </div>
    </section>
  </div>

  <%# Items Section %>
  <div class="p-6 pt-0">
    <section class="items-section">
      <div class="flex items-center justify-between border-b-2 border-parchment-border pb-2 mb-4">
        <h3 class="font-western text-lg text-wood-dark">Items</h3>
        <div class="flex items-center gap-4">
          <%# Weight capacity display %>
          <div class="items-capacity-display <%= hero.over_weight_capacity? ? 'items-over-capacity' : '' %>">
            <span class="items-capacity-label">Carrying:</span>
            <span class="items-capacity-value">
              <%= hero.total_item_weight > 0 ? anvil_icons(hero.total_item_weight) : '0' %>
            </span>
            <span class="items-capacity-separator">/</span>
            <span class="items-capacity-max"><%= hero.weight_capacity %></span>
            <% if hero.over_weight_capacity? %>
              <span class="items-over-capacity-warning" title="Over capacity! Hero is encumbered."><i class="fa-solid fa-triangle-exclamation"></i></span>
            <% end %>
          </div>
          <%# Hands display %>
          <div class="items-hands-display">
            <span class="items-hands-label">Hands:</span>
            <span class="items-hands-value"><%= hero.free_hands %>/<%= hero.total_hands %></span>
          </div>
        </div>
      </div>
      
      <% if hero.over_weight_capacity? %>
        <div class="items-encumbered-warning">
          <strong>Encumbered!</strong> This hero is carrying <%= hero.total_item_weight - hero.weight_capacity %> anvil<%= (hero.total_item_weight - hero.weight_capacity) == 1 ? '' : 's' %> more than their capacity allows.
          They may suffer penalties until items are dropped.
        </div>
      <% end %>
      
      <div id="items-list" class="items-list">
        <% if hero.items.any? %>
          <%# Show equipped items first, then unequipped %>
          <% hero.items.equipped.order(:name).each do |item| %>
            <%= render item %>
          <% end %>
          <% hero.items.unequipped.order(:name).each do |item| %>
            <%= render item %>
          <% end %>
        <% else %>
          <div class="text-center text-parchment-border italic py-4" id="no-items-message">
            No items yet
          </div>
        <% end %>
      </div>
      
      <div class="mt-4" id="item-form-container">
        <%= render "items/form", hero: hero, item: hero.items.build %>
      </div>
    </section>
  </div>

  <%# Bottom Sections: Abilities %>
  <div class="p-6 pt-0">
    <div class="info-box">
      <h3 class="font-western text-lg text-wood-dark text-center border-b-2 border-parchment-border pb-2 mb-4">Abilities</h3>
      <div class="text-sm text-parchment-border mb-2 text-center">Starting Upgrades</div>
      <div class="bg-white/50 border border-parchment-border rounded p-3 min-h-[80px]">
        <div class="text-sm text-parchment-border italic text-center">No abilities assigned</div>
      </div>
    </div>
  </div>

  <%# Injuries/Madness/Mutations Section %>
  <div class="p-6 pt-0 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <%# Injuries Section %>
    <div class="afflictions-section afflictions-injuries">
      <div class="flex items-center justify-between border-b-2 border-health-border pb-2 mb-4">
        <h3 class="font-western text-lg text-health">Injuries</h3>
        <span class="font-serif text-sm text-health"><%= hero.injuries.count %> total</span>
      </div>
      
      <% if hero.injuries.any? %>
        <div class="afflictions-list">
          <%= render hero.injuries.order(:created_at) %>
        </div>
      <% else %>
        <div class="text-center text-parchment-border italic py-4">
          No injuries
        </div>
      <% end %>
      
      <div class="mt-4">
        <%= render "injuries/form", hero: hero %>
      </div>
    </div>

    <%# Madness Section %>
    <div class="afflictions-section afflictions-madness">
      <div class="flex items-center justify-between border-b-2 border-sanity-border pb-2 mb-4">
        <h3 class="font-western text-lg text-sanity">Madness</h3>
        <span class="font-serif text-sm text-sanity"><%= hero.madnesses.count %> total</span>
      </div>
      
      <% if hero.madnesses.any? %>
        <div class="afflictions-list">
          <%= render hero.madnesses.order(:created_at) %>
        </div>
      <% else %>
        <div class="text-center text-parchment-border italic py-4">
          No madness
        </div>
      <% end %>
      
      <div class="mt-4">
        <%= render "madnesses/form", hero: hero %>
      </div>
    </div>
  </div>
  
  <%# Mutations Section %>
  <div class="p-6 pt-0">
    <div class="afflictions-section afflictions-mutations">
      <div class="flex items-center justify-between border-b-2 border-mutation-border pb-2 mb-4">
        <h3 class="font-western text-lg text-mutation">Mutations</h3>
        <span class="font-serif text-sm text-mutation"><%= hero.mutations.count %> total</span>
      </div>
      
      <% if hero.mutations.any? %>
        <div class="afflictions-list">
          <%= render hero.mutations.order(:created_at) %>
        </div>
      <% else %>
        <div class="text-center text-parchment-border italic py-4">
          No mutations
        </div>
      <% end %>
      
      <div class="mt-4">
        <%= render "mutations/form", hero: hero %>
      </div>
    </div>
  </div>
</div>
